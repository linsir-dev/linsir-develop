# TCP 建立连接过程的三次握手

TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层协议。在 TCP 协议中，建立连接的过程被称为「三次握手」（Three-way Handshake）。

## 目录

1. [TCP 协议的特点](#tcp-协议的特点)
2. [三次握手的概念](#三次握手的概念)
3. [三次握手的过程](#三次握手的过程)
4. [三次握手的目的](#三次握手的目的)
5. [序列号和确认号的作用](#序列号和确认号的作用)
6. [三次握手的详细步骤](#三次握手的详细步骤)
7. [常见问题和异常情况](#常见问题和异常情况)
8. [总结](#总结)

## TCP 协议的特点

TCP 协议具有以下特点：

- **面向连接**：在数据传输前，必须先建立连接；数据传输完成后，必须释放连接。
- **可靠传输**：通过校验和、序列号、确认号、超时重传等机制确保数据的可靠传输。
- **面向字节流**：将应用层的数据视为字节流，无消息边界。
- **全双工通信**：通信双方可以同时发送和接收数据。
- **流量控制**：通过滑动窗口机制控制发送方的发送速率，避免接收方缓冲区溢出。
- **拥塞控制**：通过慢启动、拥塞避免、快重传、快恢复等算法控制网络拥塞。

## 三次握手的概念

三次握手是 TCP 协议中建立连接的过程，需要通信双方交换三个报文段来完成连接的建立。这三个报文段分别是：

1. **SYN 报文段**：客户端向服务器发送 SYN（Synchronize Sequence Numbers，同步序列号）报文段，请求建立连接。
2. **SYN-ACK 报文段**：服务器收到 SYN 报文段后，向客户端发送 SYN-ACK（Synchronize-Acknowledge）报文段，表示同意建立连接。
3. **ACK 报文段**：客户端收到 SYN-ACK 报文段后，向服务器发送 ACK（Acknowledge）报文段，表示确认收到服务器的同意。

## 三次握手的过程

TCP 三次握手的过程如下：

1. **第一次握手（客户端 → 服务器）**：
   - 客户端发送一个 SYN 报文段，其中 SYN 标志位为 1。
   - 客户端选择一个初始序列号（ISN，Initial Sequence Number），放入 SEQ 字段。
   - 客户端进入 SYN_SENT 状态，等待服务器的响应。

2. **第二次握手（服务器 → 客户端）**：
   - 服务器收到客户端的 SYN 报文段后，发送一个 SYN-ACK 报文段，其中 SYN 和 ACK 标志位均为 1。
   - 服务器选择自己的初始序列号（ISN），放入 SEQ 字段。
   - 服务器将客户端的 ISN + 1 作为确认号（ACK Number），放入 ACK 字段，表示已经收到了客户端发送的 SYN 报文段。
   - 服务器进入 SYN_RCVD 状态，等待客户端的确认。

3. **第三次握手（客户端 → 服务器）**：
   - 客户端收到服务器的 SYN-ACK 报文段后，发送一个 ACK 报文段，其中 ACK 标志位为 1。
   - 客户端将服务器的 ISN + 1 作为确认号（ACK Number），放入 ACK 字段，表示已经收到了服务器发送的 SYN-ACK 报文段。
   - 客户端进入 ESTABLISHED 状态，表示连接已经建立，可以开始传输数据。
   - 服务器收到客户端的 ACK 报文段后，也进入 ESTABLISHED 状态，表示连接已经建立。

## 三次握手的目的

三次握手的主要目的是：

1. **确认双方的发送和接收能力**：通过三次握手，双方可以确认对方的发送和接收能力是否正常。
2. **协商初始序列号**：TCP 协议是面向字节流的，需要为每个字节分配一个序列号。三次握手的过程中，双方会协商各自的初始序列号。
3. **防止旧连接的干扰**：通过序列号的机制，可以防止过期的连接请求报文段（如网络延迟导致的）干扰新的连接。

## 序列号和确认号的作用

在 TCP 协议中，序列号（Sequence Number，SEQ）和确认号（Acknowledgment Number，ACK Number）是非常重要的字段：

- **序列号**：用于标识发送方发送的每个字节的顺序。在建立连接时，双方会选择一个初始序列号（ISN），后续发送的数据字节的序列号会从 ISN 开始递增。
- **确认号**：用于标识接收方期望收到的下一个字节的序列号。例如，如果接收方收到了序列号为 100 的字节，那么它会发送确认号为 101 的 ACK 报文段，表示期望收到序列号为 101 的字节。

## 三次握手的详细步骤

以下是 TCP 三次握手的详细步骤，包含具体的报文段内容：

### 1. 第一次握手（客户端 → 服务器）

**客户端发送的报文段**：

| 字段 | 值 | 说明 |
|------|-----|------|
| 源端口 | 客户端端口 | 客户端的端口号 |
| 目标端口 | 服务器端口 | 服务器的端口号 |
| 序列号（SEQ） | x | 客户端的初始序列号（ISN） |
| 确认号（ACK Number） | 0 | 未确认任何数据 |
| 数据偏移 | 5 | 表示 TCP 头部的长度为 20 字节 |
| 保留 | 0 | 保留字段 |
| 标志位 | SYN=1, ACK=0, FIN=0 | 表示这是一个 SYN 报文段 |
| 窗口大小 | 65535 | 客户端的接收窗口大小 |
| 校验和 | 校验和值 | 用于校验报文段的完整性 |
| 紧急指针 | 0 | 无紧急数据 |
| 选项 | MSS=1460 | 最大报文段长度 |
| 数据 | 无 | 无数据 |

**客户端状态变化**：
- 从 CLOSED 状态进入 SYN_SENT 状态。

### 2. 第二次握手（服务器 → 客户端）

**服务器发送的报文段**：

| 字段 | 值 | 说明 |
|------|-----|------|
| 源端口 | 服务器端口 | 服务器的端口号 |
| 目标端口 | 客户端端口 | 客户端的端口号 |
| 序列号（SEQ） | y | 服务器的初始序列号（ISN） |
| 确认号（ACK Number） | x+1 | 确认收到客户端的 SYN 报文段 |
| 数据偏移 | 5 | 表示 TCP 头部的长度为 20 字节 |
| 保留 | 0 | 保留字段 |
| 标志位 | SYN=1, ACK=1, FIN=0 | 表示这是一个 SYN-ACK 报文段 |
| 窗口大小 | 65535 | 服务器的接收窗口大小 |
| 校验和 | 校验和值 | 用于校验报文段的完整性 |
| 紧急指针 | 0 | 无紧急数据 |
| 选项 | MSS=1460 | 最大报文段长度 |
| 数据 | 无 | 无数据 |

**服务器状态变化**：
- 从 LISTEN 状态进入 SYN_RCVD 状态。

### 3. 第三次握手（客户端 → 服务器）

**客户端发送的报文段**：

| 字段 | 值 | 说明 |
|------|-----|------|
| 源端口 | 客户端端口 | 客户端的端口号 |
| 目标端口 | 服务器端口 | 服务器的端口号 |
| 序列号（SEQ） | x+1 | 客户端的下一个序列号 |
| 确认号（ACK Number） | y+1 | 确认收到服务器的 SYN-ACK 报文段 |
| 数据偏移 | 5 | 表示 TCP 头部的长度为 20 字节 |
| 保留 | 0 | 保留字段 |
| 标志位 | SYN=0, ACK=1, FIN=0 | 表示这是一个 ACK 报文段 |
| 窗口大小 | 65535 | 客户端的接收窗口大小 |
| 校验和 | 校验和值 | 用于校验报文段的完整性 |
| 紧急指针 | 0 | 无紧急数据 |
| 选项 | 无 | 无选项 |
| 数据 | 无 | 无数据 |

**客户端状态变化**：
- 从 SYN_SENT 状态进入 ESTABLISHED 状态。

**服务器状态变化**：
- 收到客户端的 ACK 报文段后，从 SYN_RCVD 状态进入 ESTABLISHED 状态。

## 常见问题和异常情况

### 1. 为什么需要三次握手，而不是两次？

两次握手可能会导致以下问题：

- **过期连接请求的干扰**：如果客户端发送的 SYN 报文段由于网络延迟而迟到，服务器会认为这是一个新的连接请求，发送 SYN-ACK 报文段。如果是两次握手，服务器会直接进入 ESTABLISHED 状态，等待客户端发送数据。但客户端已经超时，不会响应，导致服务器资源被浪费。
- **确认双方的发送和接收能力**：三次握手可以确保双方的发送和接收能力都正常。第一次握手确认客户端的发送能力，第二次握手确认服务器的接收和发送能力，第三次握手确认客户端的接收能力。

### 2. 三次握手过程中的异常情况

- **SYN 报文段丢失**：客户端发送 SYN 报文段后，如果在超时时间内没有收到服务器的 SYN-ACK 报文段，客户端会重新发送 SYN 报文段，最多重试几次。如果仍然失败，连接建立失败。

- **SYN-ACK 报文段丢失**：服务器发送 SYN-ACK 报文段后，如果在超时时间内没有收到客户端的 ACK 报文段，服务器会重新发送 SYN-ACK 报文段，最多重试几次。如果仍然失败，连接建立失败。

- **ACK 报文段丢失**：客户端发送 ACK 报文段后，如果服务器没有收到，服务器会重新发送 SYN-ACK 报文段。客户端收到重复的 SYN-ACK 报文段后，会再次发送 ACK 报文段，并进入 ESTABLISHED 状态。服务器收到 ACK 报文段后，进入 ESTABLISHED 状态。

## 总结

TCP 三次握手是建立连接的必要过程，它通过交换三个报文段来确认双方的发送和接收能力，协商初始序列号，防止旧连接的干扰。三次握手的过程确保了 TCP 连接的可靠性和安全性，是 TCP 协议能够提供可靠传输服务的基础。

理解 TCP 三次握手的过程，对于网络编程、网络故障排查和网络安全都具有重要的意义。
