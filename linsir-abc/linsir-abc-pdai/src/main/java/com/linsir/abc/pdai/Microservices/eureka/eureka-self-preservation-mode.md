# 什么是Eureka的自我保护模式？

## 一、自我保护模式概述

### 1.1 什么是自我保护模式

**定义**
Eureka的自我保护模式是Eureka Server在短时间内丢失大量服务实例的心跳时，进入的一种保护模式。

**触发条件**
- Eureka Server在15分钟内，丢失的心跳比例低于85%
- Eureka Server进入自我保护模式

### 1.2 自我保护模式的作用

**保护目的**
- 避免因网络分区导致的服务实例误剔除
- 保证在Eureka Server故障时，服务消费者仍然可以获取服务列表
- 提高系统的可用性

**保护机制**
- 自我保护模式下，Eureka Server不会剔除服务实例
- Eureka Server仍然可以接收服务注册和查询请求
- 服务消费者可以获取到不健康的服务实例

## 二、自我保护模式的触发

### 2.1 触发条件

**心跳丢失比例**
- Eureka Server在15分钟内，丢失的心跳比例低于85%
- 计算公式：丢失的心跳数 / 总心跳数 < 85%

**触发示例**
- Eureka Server管理100个服务实例
- 15分钟内，只有10个服务实例发送心跳
- 心跳丢失比例为90%，低于85%，触发自我保护模式

### 2.2 自我保护模式的状态

**正常模式**
- Eureka Server正常剔除不健康的服务实例
- 服务消费者可以获取到健康的服务实例

**自我保护模式**
- Eureka Server不会剔除服务实例
- 服务消费者可能获取到不健康的服务实例

## 三、自我保护模式的配置

### 3.1 开启自我保护模式

**配置示例**
```yaml
eureka:
  server:
    enable-self-preservation: true
    renewal-percent-threshold: 0.85
```

**配置说明**
- enable-self-preservation：是否开启自我保护模式，默认为true
- renewal-percent-threshold：心跳丢失比例阈值，默认为0.85

### 3.2 关闭自我保护模式

**配置示例**
```yaml
eureka:
  server:
    enable-self-preservation: false
```

**配置说明**
- enable-self-preservation：是否开启自我保护模式，默认为true
- 关闭自我保护模式后，Eureka Server会正常剔除不健康的服务实例

### 3.3 调整自我保护模式参数

**调整心跳丢失比例阈值**
```yaml
eureka:
  server:
    renewal-percent-threshold: 0.90
```

**调整心跳检查间隔**
```yaml
eureka:
  server:
    eviction-interval-timer-in-ms: 60000
```

## 四、自我保护模式的优缺点

### 4.1 优点

**避免误剔除**
- 避免因网络分区导致的服务实例误剔除
- 保证在Eureka Server故障时，服务消费者仍然可以获取服务列表
- 提高系统的可用性

**保护服务实例**
- 保护服务实例不被误剔除
- 减少服务实例的重新注册
- 提高系统的稳定性

### 4.2 缺点

**获取不健康的服务实例**
- 服务消费者可能获取到不健康的服务实例
- 服务消费者需要自己处理服务实例的故障
- 增加服务消费者的复杂度

**服务列表不准确**
- 服务列表可能包含不健康的服务实例
- 服务列表可能不准确
- 影响服务调用的成功率

## 五、自我保护模式的最佳实践

### 5.1 开启自我保护模式

**适用场景**
- 网络不稳定的环境
- 服务实例数量较多的环境
- 对可用性要求较高的环境

**配置建议**
- 开启自我保护模式
- 调整心跳丢失比例阈值
- 调整心跳检查间隔

### 5.2 关闭自我保护模式

**适用场景**
- 网络稳定的环境
- 服务实例数量较少的环境
- 对一致性要求较高的环境

**配置建议**
- 关闭自我保护模式
- 增加心跳检查频率
- 增加服务实例的容错能力

### 5.3 服务消费者容错

**容错策略**
- 服务消费者实现重试机制
- 服务消费者实现熔断机制
- 服务消费者实现降级机制

**实现示例**
```java
@FeignClient(name = "user-service", fallback = UserServiceFallback.class)
public interface UserService {
    
    @GetMapping("/users/{id}")
    User getUserById(@PathVariable("id") Long id);
}

@Component
public class UserServiceFallback implements UserService {
    
    @Override
    public User getUserById(Long id) {
        return new User();
    }
}
```

## 六、总结

Eureka的自我保护模式是Eureka Server在短时间内丢失大量服务实例的心跳时，进入的一种保护模式。自我保护模式避免了因网络分区导致的服务实例误剔除，保证了系统的可用性。

### 核心要点

1. **自我保护模式定义**：Eureka Server在短时间内丢失大量服务实例的心跳时，进入的一种保护模式
2. **自我保护模式触发条件**：心跳丢失比例低于85%
3. **自我保护模式作用**：避免误剔除，保护服务实例
4. **自我保护模式配置**：开启/关闭自我保护模式，调整自我保护模式参数
5. **自我保护模式优缺点**：优点是避免误剔除，缺点是获取不健康的服务实例
6. **自我保护模式最佳实践**：开启/关闭自我保护模式，服务消费者容错

### 配置建议

1. **网络不稳定的环境**：开启自我保护模式
2. **网络稳定的环境**：关闭自我保护模式
3. **服务消费者容错**：实现重试、熔断、降级机制

Eureka的自我保护模式是Eureka的重要特性，需要根据网络环境和业务需求选择合适的配置。
