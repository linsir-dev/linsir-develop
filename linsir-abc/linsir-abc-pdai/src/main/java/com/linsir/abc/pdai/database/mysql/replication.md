# MySQL主从复制

## 1. 什么是MySQL主从复制

**MySQL主从复制**是一种数据同步机制，用于将一个MySQL数据库服务器（主服务器）的数据复制到一个或多个MySQL数据库服务器（从服务器）。它是MySQL高可用性、扩展性和灾备方案的基础。

## 2. 主从复制的作用

### 2.1 高可用性

- **故障转移**：当主服务器故障时，可以切换到从服务器
- **负载均衡**：将读操作分散到从服务器，提高系统可用性

### 2.2 扩展性

- **水平扩展**：通过增加从服务器，提高系统的读处理能力
- **分担压力**：主服务器专注于写操作，从服务器专注于读操作

### 2.3 数据安全

- **数据备份**：从服务器可以作为主服务器的数据备份
- **避免备份影响**：在从服务器上执行备份，不影响主服务器性能

### 2.4 数据分发

- **地理分布式部署**：将数据复制到不同地理位置的服务器
- **就近访问**：用户可以访问离自己最近的服务器，减少网络延迟

## 3. 主从复制的原理

### 3.1 复制的基本流程

MySQL主从复制的基本流程如下：

1. **主服务器**：将数据变更记录到二进制日志（binary log）
2. **从服务器**：
   - 从主服务器读取二进制日志（通过I/O线程）
   - 将读取的二进制日志写入中继日志（relay log）
   - 执行中继日志中的事件（通过SQL线程），将数据变更应用到从服务器

### 3.2 复制的关键组件

#### 3.2.1 二进制日志（Binary Log）

**二进制日志**是主服务器上记录所有数据变更的日志文件。

**格式**：
- **STATEMENT**：记录SQL语句
- **ROW**：记录行的变更
- **MIXED**：混合模式

**作用**：
- 记录数据变更
- 用于主从复制
- 用于数据恢复

#### 3.2.2 中继日志（Relay Log）

**中继日志**是从服务器上存储从主服务器读取的二进制日志的临时文件。

**作用**：
- 存储主服务器的二进制日志
- 提供缓冲，避免主从直接依赖

#### 3.2.3 复制线程

**从服务器**有两个关键线程：

1. **I/O线程**：
   - 连接主服务器
   - 读取主服务器的二进制日志
   - 将读取的内容写入中继日志

2. **SQL线程**：
   - 读取中继日志
   - 执行中继日志中的事件
   - 将数据变更应用到从服务器

**主服务器**有一个关键线程：

- **Dump线程**：
   - 响应从服务器的I/O线程请求
   - 发送二进制日志内容

## 4. 主从复制的类型

### 4.1 异步复制

**异步复制**是MySQL默认的复制模式，主服务器在执行完事务后立即提交，不需要等待从服务器确认。

**特点**：
- 性能高
- 主服务器故障可能导致数据丢失
- 从服务器可能落后于主服务器

### 4.2 半同步复制

**半同步复制**是一种增强的复制模式，主服务器在执行完事务后，需要等待至少一个从服务器确认收到二进制日志后才提交。

**特点**：
- 数据安全性高
- 性能略低于异步复制
- 主服务器故障时数据丢失风险低

### 4.3 组复制

**组复制**是MySQL 5.7+引入的一种复制模式，基于Paxos算法实现多主复制。

**特点**：
- 多主架构
- 自动故障转移
- 数据一致性保证
- 适合高可用性场景

## 5. 主从复制的配置

### 5.1 主服务器配置

#### 5.1.1 基本配置

**编辑my.cnf文件**：

```ini
[mysqld]
# 启用二进制日志
log-bin=mysql-bin
# 服务器唯一ID
server-id=1
# 二进制日志格式
binlog-format=ROW
# 跳过错误（可选）
sql-slave-skip-counter=1
# 允许从服务器连接
skip-networking=0
```

#### 5.1.2 创建复制用户

**在主服务器上创建复制用户**：

```sql
CREATE USER 'repl'@'%' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;
```

#### 5.1.3 查看主服务器状态

**查看主服务器的二进制日志状态**：

```sql
SHOW MASTER STATUS;
```

**输出**：
| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
|------|----------|-------------|------------------|-------------------|
| mysql-bin.000001 | 107 | | | |

### 5.2 从服务器配置

#### 5.2.1 基本配置

**编辑my.cnf文件**：

```ini
[mysqld]
# 服务器唯一ID（必须与主服务器不同）
server-id=2
# 启用中继日志
relay-log=relay-log
# 只读模式（可选）
read-only=1
# 跳过错误（可选）
sql-slave-skip-counter=1
```

#### 5.2.2 配置复制连接

**在从服务器上配置复制连接**：

```sql
CHANGE MASTER TO
MASTER_HOST='master_ip',
MASTER_USER='repl',
MASTER_PASSWORD='password',
MASTER_LOG_FILE='mysql-bin.000001',
MASTER_LOG_POS=107;
```

#### 5.2.3 启动复制

**在从服务器上启动复制**：

```sql
START SLAVE;
```

#### 5.2.4 查看复制状态

**查看从服务器的复制状态**：

```sql
SHOW SLAVE STATUS\G;
```

**关键状态**：
- `Slave_IO_Running`：I/O线程状态
- `Slave_SQL_Running`：SQL线程状态
- `Seconds_Behind_Master`：从服务器落后于主服务器的秒数

## 6. 主从复制的常见问题

### 6.1 复制延迟

**问题**：从服务器的数据落后于主服务器。

**原因**：
- 网络延迟
- 从服务器性能不足
- 主服务器写入压力大
- 大事务

**解决方案**：
- 优化网络连接
- 提升从服务器性能
- 配置半同步复制
- 拆分大事务
- 使用并行复制

### 6.2 复制错误

**问题**：复制过程中出现错误，导致复制停止。

**原因**：
- 主从数据不一致
- 从服务器上有未提交的事务
- 权限问题
- SQL语句错误

**解决方案**：
- 跳过错误：`SET GLOBAL SQL_SLAVE_SKIP_COUNTER = 1; START SLAVE;`
- 重新初始化从服务器
- 检查并修复数据不一致

### 6.3 主服务器故障

**问题**：主服务器故障，需要将从服务器提升为主服务器。

**解决方案**：
- 手动故障转移：
  1. 停止从服务器的复制：`STOP SLAVE;`
  2. 重置从服务器状态：`RESET MASTER;`
  3. 更新应用连接到新的主服务器
- 自动故障转移：使用MySQL Router或ProxySQL

### 6.4 数据一致性问题

**问题**：主从服务器数据不一致。

**原因**：
- 复制错误未及时处理
- 从服务器上执行了写操作
- 网络中断导致部分复制

**解决方案**：
- 定期校验数据一致性：使用pt-table-checksum工具
- 修复数据不一致：使用pt-table-sync工具
- 配置从服务器为只读模式

## 7. 主从复制的优化

### 7.1 网络优化

- 使用专用网络进行复制
- 配置合适的网络缓冲区大小
- 启用压缩传输：`SET GLOBAL slave_compressed_protocol = 1;`

### 7.2 服务器优化

- **主服务器**：
  - 调整二进制日志参数
  - 优化写入性能

- **从服务器**：
  - 提升硬件配置
  - 配置并行复制：`slave_parallel_workers = 4`
  - 启用中继日志自动净化：`relay_log_purge = 1`

### 7.3 复制配置优化

- 使用ROW格式的二进制日志
- 启用半同步复制
- 配置适当的复制超时参数
- 定期清理二进制日志和中继日志

### 7.4 监控优化

- 监控复制延迟
- 监控复制错误
- 监控服务器状态
- 建立告警机制

## 8. 主从复制的高级特性

### 8.1 并行复制

**并行复制**是指从服务器使用多个SQL线程并行应用中继日志中的事件，提高复制速度。

**配置**：

```ini
# MySQL 5.7+
slave_parallel_workers=4
# MySQL 8.0+
slave_parallel_type=LOGICAL_CLOCK
```

### 8.2 GTID复制

**GTID（Global Transaction ID）**是MySQL 5.6+引入的一种复制方式，使用全局唯一的事务ID标识每个事务。

**配置**：

```ini
# 主从服务器都需要配置
gtid_mode=ON
enforce_gtid_consistency=ON
```

**优势**：
- 简化复制配置
- 自动故障转移更可靠
- 避免复制错误

### 8.3 多源复制

**多源复制**是MySQL 5.7+引入的一种复制方式，允许从服务器同时从多个主服务器复制数据。

**配置**：

```sql
# 为每个主服务器创建复制通道
CHANGE MASTER TO
MASTER_HOST='master1_ip',
MASTER_USER='repl',
MASTER_PASSWORD='password',
MASTER_LOG_FILE='mysql-bin.000001',
MASTER_LOG_POS=107
FOR CHANNEL 'master1';

CHANGE MASTER TO
MASTER_HOST='master2_ip',
MASTER_USER='repl',
MASTER_PASSWORD='password',
MASTER_LOG_FILE='mysql-bin.000001',
MASTER_LOG_POS=107
FOR CHANNEL 'master2';

# 启动所有通道
START SLAVE FOR ALL CHANNELS;
```

## 9. 主从复制的实践案例

### 9.1 一主多从架构

**架构**：一个主服务器，多个从服务器。

**适用场景**：
- 读多写少的应用
- 需要数据备份的场景

**优势**：
- 提高读性能
- 增强数据安全性

### 9.2 级联复制架构

**架构**：主服务器 → 从服务器 → 从服务器（级联）。

**适用场景**：
- 从服务器数量较多
- 减少主服务器的复制压力

**优势**：
- 减轻主服务器负担
- 提高扩展性

### 9.3 双主复制架构

**架构**：两个服务器互为主从。

**适用场景**：
- 需要高可用性的应用
- 需要负载均衡的场景

**优势**：
- 自动故障转移
- 负载均衡

### 9.4 主从复制与读写分离

**架构**：主服务器处理写操作，从服务器处理读操作。

**实现方式**：
- 应用层读写分离
- 中间件读写分离（如MySQL Router、ProxySQL）

**优势**：
- 提高系统并发性能
- 减轻主服务器负担

## 10. 总结

MySQL主从复制是一种强大的数据同步机制，为MySQL数据库提供了高可用性、扩展性和数据安全性。通过合理配置和优化，可以构建可靠的数据库集群，满足不同业务场景的需求。

在实际应用中，需要根据业务特点选择合适的复制类型和架构，配置最佳的参数，建立完善的监控和故障处理机制，以确保主从复制的稳定运行。随着MySQL版本的更新，复制功能也在不断增强，如GTID、并行复制、多源复制等特性，为构建更可靠、更高效的数据库架构提供了更多选择。