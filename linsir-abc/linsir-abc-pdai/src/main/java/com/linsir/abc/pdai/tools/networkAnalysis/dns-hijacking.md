# 什么是 DNS 劫持？

DNS 劫持（DNS Hijacking）是一种网络攻击技术，攻击者通过篡改 DNS 解析过程，将域名解析到错误的 IP 地址，导致用户访问到恶意网站或被重定向到钓鱼网站。DNS 劫持是一种常见的网络安全威胁，可能导致用户的个人信息泄露、财产损失等严重后果。

## 目录

1. [DNS 劫持的概念](#dns-劫持的概念)
2. [DNS 劫持的原理](#dns-劫持的原理)
3. [DNS 劫持的类型](#dns-劫持的类型)
   - [本地 DNS 劫持](#本地-dns-劫持)
   - [路由器 DNS 劫持](#路由器-dns-劫持)
   - [DNS 服务器劫持](#dns-服务器劫持)
   - [中间人 DNS 劫持](#中间人-dns-劫持)
4. [DNS 劫持的危害](#dns-劫持的危害)
5. [DNS 劫持的防范措施](#dns-劫持的防范措施)
6. [DNS 劫持的检测方法](#dns-劫持的检测方法)
7. [DNS 劫持的案例分析](#dns-劫持的案例分析)
8. [DNS 安全技术](#dns-安全技术)
9. [总结](#总结)

## DNS 劫持的概念

DNS 劫持是指攻击者通过各种手段，篡改 DNS 解析过程，使得域名解析到错误的 IP 地址。当用户在浏览器中输入域名时，DNS 服务器会返回攻击者控制的 IP 地址，导致用户访问到攻击者设置的恶意网站，而不是用户原本想要访问的网站。

DNS 劫持的本质是破坏了 DNS 解析的完整性和真实性，使得用户无法通过域名访问到正确的网站。

## DNS 劫持的原理

DNS 劫持的原理基于 DNS 解析的过程。正常的 DNS 解析过程如下：

1. 用户在浏览器中输入域名，如 www.example.com。
2. 浏览器向本地 DNS 服务器发送查询请求。
3. 本地 DNS 服务器向根域名服务器、顶级域名服务器、权威域名服务器发送查询请求。
4. 权威域名服务器返回域名对应的 IP 地址。
5. 本地 DNS 服务器将 IP 地址返回给浏览器。
6. 浏览器使用 IP 地址与目标服务器建立连接。

DNS 劫持的原理是在上述过程中的某个环节进行篡改，使得 DNS 解析返回错误的 IP 地址。具体来说，攻击者可以：

1. **篡改本地 DNS 配置**：修改用户计算机或移动设备的 DNS 服务器设置，指向攻击者控制的 DNS 服务器。

2. **篡改路由器 DNS 配置**：入侵用户的路由器，修改路由器的 DNS 服务器设置，指向攻击者控制的 DNS 服务器。

3. **攻击 DNS 服务器**：入侵 DNS 服务器，修改 DNS 记录，将域名解析到错误的 IP 地址。

4. **中间人攻击**：在用户和 DNS 服务器之间拦截和篡改 DNS 查询和响应，返回错误的 IP 地址。

## DNS 劫持的类型

### 1. 本地 DNS 劫持

本地 DNS 劫持是指攻击者修改用户计算机或移动设备的 DNS 配置，指向攻击者控制的 DNS 服务器。

**攻击方式**：
- 通过恶意软件修改用户计算机的 DNS 服务器设置。
- 通过社会工程学手段，诱骗用户手动修改 DNS 服务器设置。
- 利用操作系统漏洞，远程修改用户计算机的 DNS 服务器设置。

**防范措施**：
- 安装杀毒软件和防火墙，防止恶意软件感染。
- 定期检查计算机的 DNS 服务器设置，确保其正确。
- 及时更新操作系统和软件，修复安全漏洞。

### 2. 路由器 DNS 劫持

路由器 DNS 劫持是指攻击者入侵用户的路由器，修改路由器的 DNS 服务器设置，指向攻击者控制的 DNS 服务器。

**攻击方式**：
- 利用路由器默认密码或弱密码，登录路由器管理界面，修改 DNS 服务器设置。
- 利用路由器固件漏洞，远程入侵路由器，修改 DNS 服务器设置。
- 通过恶意软件感染用户计算机，然后利用计算机与路由器的连接，修改路由器的 DNS 服务器设置。

**防范措施**：
- 更改路由器的默认密码，使用强密码。
- 及时更新路由器固件，修复安全漏洞。
- 禁用路由器的远程管理功能。
- 定期检查路由器的 DNS 服务器设置，确保其正确。

### 3. DNS 服务器劫持

DNS 服务器劫持是指攻击者入侵 DNS 服务器，修改 DNS 记录，将域名解析到错误的 IP 地址。

**攻击方式**：
- 利用 DNS 服务器的漏洞，远程入侵 DNS 服务器，修改 DNS 记录。
- 通过社会工程学手段，获取 DNS 服务器的管理权限，修改 DNS 记录。
- 利用 DNS 区域传输漏洞，获取 DNS 区域文件，然后修改并重新加载。

**防范措施**：
- 及时更新 DNS 服务器软件，修复安全漏洞。
- 使用强密码保护 DNS 服务器的管理权限。
- 限制 DNS 区域传输的范围，只允许授权的服务器进行区域传输。
- 启用 DNSSEC，防止 DNS 记录被篡改。

### 4. 中间人 DNS 劫持

中间人 DNS 劫持是指攻击者在用户和 DNS 服务器之间拦截和篡改 DNS 查询和响应，返回错误的 IP 地址。

**攻击方式**：
- ARP 欺骗：攻击者向局域网内的设备发送伪造的 ARP 数据包，将自己的 MAC 地址与网关的 IP 地址绑定，拦截所有网络流量。
- DNS 欺骗：攻击者监听网络中的 DNS 查询，当发现目标域名的查询时，发送伪造的 DNS 响应，返回错误的 IP 地址。
- SSL 剥离：攻击者拦截 HTTPS 连接，将其降级为 HTTP 连接，然后进行 DNS 劫持。

**防范措施**：
- 使用 HTTPS 协议，防止中间人攻击。
- 启用 DNSSEC，确保 DNS 响应的真实性。
- 使用 VPN，加密网络流量，防止被拦截。
- 在局域网中使用静态 ARP 表，防止 ARP 欺骗。

## DNS 劫持的危害

DNS 劫持的危害主要包括：

1. **钓鱼攻击**：攻击者将域名解析到钓鱼网站，诱导用户输入个人信息、银行账号、密码等敏感信息，导致信息泄露和财产损失。

2. **恶意软件分发**：攻击者将域名解析到恶意网站，强制用户下载和安装恶意软件，如木马、勒索软件等。

3. **广告劫持**：攻击者将域名解析到自己的服务器，在用户访问网站时插入广告，获取广告收益。

4. **服务中断**：攻击者将域名解析到不存在的 IP 地址或错误的服务器，导致用户无法访问正常的网站，造成服务中断。

5. **数据窃取**：攻击者通过 DNS 劫持，拦截用户的网络流量，窃取用户的个人信息、聊天记录、邮件内容等敏感数据。

6. **声誉损害**：如果企业的域名被劫持，用户访问到恶意网站，可能会对企业的声誉造成严重损害。

## DNS 劫持的防范措施

### 1. 使用安全的 DNS 服务器

- 使用知名的公共 DNS 服务器，如 Google DNS（8.8.8.8、8.8.4.4）、Cloudflare DNS（1.1.1.1、1.0.0.1）、Quad9 DNS（9.9.9.9）等。
- 这些公共 DNS 服务器通常具有更好的安全性和可靠性，能够有效防止 DNS 劫持。

### 2. 启用 DNSSEC

- DNSSEC（DNS Security Extensions，DNS 安全扩展）是一种 DNS 安全技术，它通过数字签名来确保 DNS 记录的真实性和完整性，防止 DNS 劫持。
- 网站管理员应该为自己的域名启用 DNSSEC，用户应该选择支持 DNSSEC 的 DNS 服务器。

### 3. 使用加密的 DNS 协议

- 使用 DNS over HTTPS（DoH）或 DNS over TLS（DoT）等加密的 DNS 协议，防止 DNS 查询被拦截和篡改。
- 现代浏览器和操作系统已经开始支持这些加密的 DNS 协议，用户可以在设置中启用它们。

### 4. 定期检查 DNS 设置

- 定期检查计算机、移动设备和路由器的 DNS 服务器设置，确保其指向正确的 DNS 服务器。
- 如果发现 DNS 设置被篡改，应立即恢复为正确的设置。

### 5. 安装安全软件

- 安装杀毒软件、防火墙和网络安全软件，防止恶意软件感染和网络攻击。
- 定期更新安全软件的病毒库和定义，确保其能够检测和清除最新的恶意软件。

### 6. 保持软件更新

- 及时更新操作系统、浏览器、路由器固件等软件，修复安全漏洞，防止被攻击者利用。
- 开启自动更新功能，确保软件能够及时获取安全补丁。

### 7. 使用 VPN

- 使用 VPN（Virtual Private Network，虚拟私人网络），加密网络流量，防止被中间人攻击和 DNS 劫持。
- 选择信誉良好的 VPN 服务提供商，确保其不会记录用户的网络活动。

### 8. 提高安全意识

- 提高网络安全意识，不要点击可疑的链接和附件，不要访问可疑的网站。
- 不要轻易透露个人信息和密码，使用强密码并定期更换。
- 定期备份重要数据，防止数据丢失。

## DNS 劫持的检测方法

### 1. 手动检测

- **使用 nslookup 或 dig 命令**：在命令行中使用 nslookup 或 dig 命令查询域名的 IP 地址，然后与官方公布的 IP 地址进行对比，看是否一致。
  ```bash
  # 使用 nslookup
  nslookup www.example.com
  
  # 使用 dig
  dig www.example.com
  ```

- **检查 DNS 服务器设置**：在计算机或路由器的网络设置中，检查 DNS 服务器地址是否正确。
  ```bash
  # 在 Windows 中
  ipconfig /all
  
  # 在 Linux 或 macOS 中
  cat /etc/resolv.conf
  ```

### 2. 使用在线工具

- **DNS 检测工具**：使用在线 DNS 检测工具，如 DNS Checker、WhatsMyDNS 等，检查域名在不同 DNS 服务器上的解析结果是否一致。

- **安全扫描工具**：使用在线安全扫描工具，如 VirusTotal、Norton SafeWeb 等，检查网站是否被标记为恶意网站。

### 3. 监控网络流量

- **使用网络监控工具**：使用 Wireshark、tcpdump 等网络监控工具，捕获和分析网络流量，查看是否有异常的 DNS 查询和响应。

- **使用 DNS 监控工具**：使用专门的 DNS 监控工具，如 DNS Monitor、DNS Watch 等，监控 DNS 解析的状态和变化。

## DNS 劫持的案例分析

### 案例 1：路由器 DNS 劫持

**背景**：2018 年，一种名为 "DNSChanger" 的恶意软件感染了全球数百万台路由器，修改了路由器的 DNS 服务器设置，指向攻击者控制的 DNS 服务器。

**攻击方式**：攻击者利用路由器的默认密码或弱密码，登录路由器管理界面，修改 DNS 服务器设置。

**危害**：用户访问银行、电商等网站时，被重定向到钓鱼网站，导致个人信息和财产损失。

**防范措施**：更改路由器的默认密码，使用强密码；及时更新路由器固件，修复安全漏洞；定期检查路由器的 DNS 服务器设置。

### 案例 2：ISP DNS 劫持

**背景**：某些互联网服务提供商（ISP）为了获取广告收益，对用户的 DNS 查询进行劫持，当用户访问不存在的域名时，返回 ISP 自己的广告页面。

**攻击方式**：ISP 修改自己的 DNS 服务器设置，对不存在的域名返回广告页面的 IP 地址。

**危害**：用户被强制观看广告，影响用户体验；可能会被重定向到恶意网站，导致信息泄露。

**防范措施**：使用公共 DNS 服务器，如 Google DNS、Cloudflare DNS 等；启用 DNSSEC，确保 DNS 响应的真实性。

### 案例 3：中间人 DNS 劫持

**背景**：2019 年，一种名为 "DNS spoofing" 的攻击在公共场所（如咖啡馆、机场）的 Wi-Fi 网络中流行，攻击者通过 ARP 欺骗拦截用户的 DNS 查询，返回错误的 IP 地址。

**攻击方式**：攻击者向局域网内的设备发送伪造的 ARP 数据包，将自己的 MAC 地址与网关的 IP 地址绑定，拦截所有网络流量，包括 DNS 查询。

**危害**：用户访问网站时被重定向到钓鱼网站，导致个人信息泄露；可能会被强制下载恶意软件。

**防范措施**：在公共场所使用 Wi-Fi 时，使用 VPN 加密网络流量；使用 HTTPS 协议，防止中间人攻击；启用 DNSSEC，确保 DNS 响应的真实性。

## DNS 安全技术

### 1. DNSSEC

DNSSEC 是 DNS 安全扩展，它通过数字签名来确保 DNS 记录的真实性和完整性，防止 DNS 劫持。DNSSEC 的工作原理是：

- 域名所有者为自己的域名生成密钥对（公钥和私钥）。
- 域名所有者使用私钥对 DNS 记录进行签名，生成数字签名。
- 数字签名与 DNS 记录一起存储在 DNS 服务器中。
- DNS 服务器在响应 DNS 查询时，将数字签名一起返回给客户端。
- 客户端使用公钥验证数字签名的真实性，确保 DNS 记录没有被篡改。

### 2. DNS over HTTPS (DoH)

DoH 是一种将 DNS 查询加密并通过 HTTPS 协议传输的技术，它可以防止 DNS 查询被拦截和篡改。DoH 的工作原理是：

- 客户端将 DNS 查询封装在 HTTPS 请求中，发送给支持 DoH 的 DNS 服务器。
- DNS 服务器收到 HTTPS 请求后，解析其中的 DNS 查询，返回 DNS 响应。
- DNS 响应被封装在 HTTPS 响应中，发送回客户端。
- 客户端解析 HTTPS 响应，获取 DNS 响应。

### 3. DNS over TLS (DoT)

DoT 是一种将 DNS 查询加密并通过 TLS 协议传输的技术，它也可以防止 DNS 查询被拦截和篡改。DoT 的工作原理与 DoH 类似，但它使用专门的端口（853）而不是 HTTPS 的端口（443）。

### 4. DNS over QUIC (DoQ)

DoQ 是一种基于 QUIC 协议的 DNS 传输技术，它结合了 UDP 的速度和 TCP 的可靠性，有望成为未来 DNS 传输的标准。

## 总结

DNS 劫持是一种常见的网络安全威胁，它通过篡改 DNS 解析过程，将域名解析到错误的 IP 地址，导致用户访问到恶意网站或被重定向到钓鱼网站。DNS 劫持的危害包括个人信息泄露、财产损失、服务中断等，严重影响用户的网络安全和正常使用。

为了防范 DNS 劫持，用户应该采取以下措施：

1. 使用安全的 DNS 服务器，如 Google DNS、Cloudflare DNS 等。
2. 启用 DNSSEC，确保 DNS 记录的真实性和完整性。
3. 使用加密的 DNS 协议，如 DoH 或 DoT，防止 DNS 查询被拦截和篡改。
4. 定期检查计算机、移动设备和路由器的 DNS 设置，确保其指向正确的 DNS 服务器。
5. 安装安全软件，保持软件更新，防止恶意软件感染和网络攻击。
6. 使用 VPN，加密网络流量，防止被中间人攻击和 DNS 劫持。
7. 提高网络安全意识，不要点击可疑的链接和附件，不要访问可疑的网站。

同时，网站管理员也应该采取措施，保护自己的域名不被劫持：

1. 为域名启用 DNSSEC，防止 DNS 记录被篡改。
2. 使用强密码保护域名注册账号和 DNS 服务器的管理权限。
3. 定期检查 DNS 记录，确保其没有被篡改。
4. 选择可靠的域名注册商和 DNS 服务提供商，确保其具有良好的安全性和可靠性。

通过采取这些措施，我们可以有效防范 DNS 劫持，保护自己的网络安全和个人信息。
